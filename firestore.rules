rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- HELPER FUNCTIONS ---

    function isAuthenticated() {
      return request.auth != null;
    }

    function isAdmin() {
      return isAuthenticated() && (
        // Preferred: Custom Claims
        request.auth.token.admin == true ||
        // Legacy: Strict whitelist (No Regex)
        request.auth.token.email in ["admin@thecampushelper.com"]
      );
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Validates resource structure and ownership
    function isValidResource(data) {
      return data.keys().hasAll(['title', 'subject', 'type', 'downloadUrl', 'ownerId'])
             && data.title is string && data.title.size() > 3 && data.title.size() < 200
             && data.subject is string && data.subject.size() > 0
             && data.downloadUrl is string && data.downloadUrl.size() < 2000
             && data.ownerId is string;
    }

    // Prevents privilege escalation
    function isValidProfileUpdate(newData, currentData) {
      let isRoleUnchanged = !("role" in newData) || (currentData != null && "role" in currentData && newData.role == currentData.role);
      let isAdminUnchanged = !("isAdmin" in newData) || (currentData != null && "isAdmin" in currentData && newData.isAdmin == currentData.isAdmin);
      return isRoleUnchanged && isAdminUnchanged;
    }

    // --- COLLECTION RULES ---

    // USERS COLLECTION
    match /users/{userId} {
      // Allow authenticated users to read their own profile or leaderboard data
      allow read: if isAuthenticated();
      
      allow create: if isOwner(userId) && isValidProfileUpdate(request.resource.data, null);
      allow update: if isOwner(userId) && isValidProfileUpdate(request.resource.data, resource.data);
      allow delete: if isAdmin();
    }

    // RESOURCES COLLECTION
    match /resources/{resourceId} {
      allow read: if isAuthenticated();
      
      // CREATE: Admin Only + Validation + No Client Timestamp/Role tampering
      allow create: if isAdmin() 
                    && isValidResource(request.resource.data)
                    && request.resource.data.createdAt == request.time
                    && !('isAdmin' in request.resource.data || 'role' in request.resource.data);
                    
      // UPDATE: Admin Only + Validation
      allow update: if isAdmin() 
                    && isValidResource(request.resource.data)
                    && !('isAdmin' in request.resource.data || 'role' in request.resource.data);
                    
      allow delete: if isAdmin();
    }

    // STUDY GROUPS COLLECTION
    match /studyGroups/{groupId} {
      // Anyone authenticated can read public groups, members can read their private groups
      allow read: if isAuthenticated() && (
        !resource.data.isPrivate || 
        request.auth.uid in resource.data.members
      );
      
      // Any authenticated user can create a group
      allow create: if isAuthenticated()
                    && request.resource.data.createdBy == request.auth.uid
                    && request.auth.uid in request.resource.data.members
                    && request.auth.uid in request.resource.data.admins;
      
      // Only group admins can update
      allow update: if isAuthenticated() && request.auth.uid in resource.data.admins;
      
      // Only group admins can delete
      allow delete: if isAuthenticated() && request.auth.uid in resource.data.admins;
    }

    // MESSAGES COLLECTION (subcollection of study groups)
    match /studyGroups/{groupId}/messages/{messageId} {
      // Members can read messages in their groups
      allow read: if isAuthenticated() && 
                    request.auth.uid in get(/databases/$(database)/documents/studyGroups/$(groupId)).data.members;
      
      // Members can create messages in their groups
      allow create: if isAuthenticated() && 
                    request.auth.uid in get(/databases/$(database)/documents/studyGroups/$(groupId)).data.members &&
                    request.resource.data.senderId == request.auth.uid;
      
      // Only message sender can update their own messages
      allow update: if isAuthenticated() && request.auth.uid == resource.data.senderId;
      
      // Message sender or group admin can delete
      allow delete: if isAuthenticated() && (
        request.auth.uid == resource.data.senderId ||
        request.auth.uid in get(/databases/$(database)/documents/studyGroups/$(groupId)).data.admins
      );
    }

    // SESSIONS COLLECTION (subcollection of study groups)
    match /studyGroups/{groupId}/sessions/{sessionId} {
      // Members can read sessions in their groups
      allow read: if isAuthenticated() && 
                    request.auth.uid in get(/databases/$(database)/documents/studyGroups/$(groupId)).data.members;
      
      // Group admins can create sessions
      allow create: if isAuthenticated() && 
                    request.auth.uid in get(/databases/$(database)/documents/studyGroups/$(groupId)).data.admins &&
                    request.resource.data.createdBy == request.auth.uid;
      
      // Group admins or session creator can update
      allow update: if isAuthenticated() && (
        request.auth.uid in get(/databases/$(database)/documents/studyGroups/$(groupId)).data.admins ||
        request.auth.uid == resource.data.createdBy
      );
      
      // Group admins or session creator can delete
      allow delete: if isAuthenticated() && (
        request.auth.uid in get(/databases/$(database)/documents/studyGroups/$(groupId)).data.admins ||
        request.auth.uid == resource.data.createdBy
      );
    }

    // COLLABORATIVE NOTES COLLECTION (subcollection of study groups)
    match /studyGroups/{groupId}/notes/{noteId} {
      // Members can read notes in their groups
      allow read: if isAuthenticated() && 
                    request.auth.uid in get(/databases/$(database)/documents/studyGroups/$(groupId)).data.members;
      
      // Members can create notes in their groups
      allow create: if isAuthenticated() && 
                    request.auth.uid in get(/databases/$(database)/documents/studyGroups/$(groupId)).data.members &&
                    request.resource.data.createdBy == request.auth.uid;
      
      // Members can update notes (collaborative editing)
      allow update: if isAuthenticated() && 
                    request.auth.uid in get(/databases/$(database)/documents/studyGroups/$(groupId)).data.members &&
                    request.resource.data.lastEditedBy == request.auth.uid;
      
      // Note creator or group admin can delete
      allow delete: if isAuthenticated() && (
        request.auth.uid == resource.data.createdBy ||
        request.auth.uid in get(/databases/$(database)/documents/studyGroups/$(groupId)).data.admins
      );
    }

    match /{document=**} {
      allow read, write: if false;
    }
  }
}