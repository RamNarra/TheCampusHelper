rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- HELPER FUNCTIONS ---

    function isAuthenticated() {
      return request.auth != null;
    }

    function isAdmin() {
      return isAuthenticated() && (
        // Preferred: Custom Claims
        request.auth.token.admin == true ||
        // Legacy: Strict whitelist (No Regex)
        request.auth.token.email in ["admin@thecampushelper.com"]
      );
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Validates resource structure and ownership
    function isValidResource(data) {
      return data.keys().hasAll(['title', 'subject', 'type', 'downloadUrl', 'ownerId'])
             && data.title is string && data.title.size() > 3 && data.title.size() < 200
             && data.subject is string && data.subject.size() > 0
             && data.downloadUrl is string && data.downloadUrl.size() < 2000
             && data.ownerId is string;
    }

    // Prevents privilege escalation
    function isValidProfileUpdate(newData, currentData) {
      let isRoleUnchanged = !("role" in newData) || (currentData != null && "role" in currentData && newData.role == currentData.role);
      let isAdminUnchanged = !("isAdmin" in newData) || (currentData != null && "isAdmin" in currentData && newData.isAdmin == currentData.isAdmin);
      return isRoleUnchanged && isAdminUnchanged;
    }

    // --- COLLECTION RULES ---

    // USERS COLLECTION
    match /users/{userId} {
      // Allow authenticated users to read their own profile or leaderboard data
      allow read: if isAuthenticated();
      
      allow create: if isOwner(userId) && isValidProfileUpdate(request.resource.data, null);
      allow update: if isOwner(userId) && isValidProfileUpdate(request.resource.data, resource.data);
      allow delete: if isAdmin();
    }

    // RESOURCES COLLECTION
    match /resources/{resourceId} {
      allow read: if isAuthenticated();
      
      // CREATE: Admin Only + Validation + No Client Timestamp/Role tampering
      allow create: if isAdmin() 
                    && isValidResource(request.resource.data)
                    && request.resource.data.createdAt == request.time
                    && !('isAdmin' in request.resource.data || 'role' in request.resource.data);
                    
      // UPDATE: Admin Only + Validation
      allow update: if isAdmin() 
                    && isValidResource(request.resource.data)
                    && !('isAdmin' in request.resource.data || 'role' in request.resource.data);
                    
      allow delete: if isAdmin();
    }

    match /{document=**} {
      allow read, write: if false;
    }
  }
}