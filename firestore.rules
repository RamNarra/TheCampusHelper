rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- HELPER FUNCTIONS ---

    function isAuthenticated() {
      return request.auth != null;
    }

    function isAdmin() {
      return isAuthenticated() && 
        (request.auth.token.email.matches(".*@example.com") || 
         request.auth.token.email in ["admin@thecampushelper.com", "yours@email.com"]);
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Validates that the uploaded resource has all required fields and reasonable limits
    function isValidResource(data) {
      return data.keys().hasAll(['title', 'subject', 'type', 'downloadUrl'])
             && data.title is string && data.title.size() > 3 && data.title.size() < 200
             && data.subject is string && data.subject.size() > 0
             && data.downloadUrl is string && data.downloadUrl.size() < 2000;
    }

    // Prevents privilege escalation during profile updates
    function isValidProfileUpdate(newData, currentData) {
      // 1. Prevent setting 'role' or 'isAdmin' fields if they don't exist
      // 2. If they exist, ensure they haven't changed (unless it's a backend trigger, but here we assume client only)
      // Ideally, simple constraint: Users cannot write to 'role' or 'isAdmin'
      
      let isRoleUnchanged = !("role" in newData) || (currentData != null && "role" in currentData && newData.role == currentData.role);
      let isAdminUnchanged = !("isAdmin" in newData) || (currentData != null && "isAdmin" in currentData && newData.isAdmin == currentData.isAdmin);
      
      return isRoleUnchanged && isAdminUnchanged;
    }

    // --- COLLECTION RULES ---

    // USERS COLLECTION
    match /users/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      
      // Create: User can create their own profile, but cannot set role/isAdmin
      allow create: if isOwner(userId) && isValidProfileUpdate(request.resource.data, null);
      
      // Update: User can update non-privileged fields
      allow update: if isOwner(userId) && isValidProfileUpdate(request.resource.data, resource.data);
      
      // Delete: Only admins
      allow delete: if isAdmin();
    }

    // RESOURCES COLLECTION
    match /resources/{resourceId} {
      // Read: Public for authenticated users
      allow read: if isAuthenticated();
      
      // Create: Admin Only + Validation + Server Timestamp Enforcement
      allow create: if isAdmin() 
                    && isValidResource(request.resource.data)
                    && request.resource.data.createdAt == request.time;
                    
      // Update: Admin Only + Validation
      allow update: if isAdmin() 
                    && isValidResource(request.resource.data);
                    
      // Delete: Admin Only
      allow delete: if isAdmin();
    }

    // Default Deny
    match /{document=**} {
      allow read, write: if false;
    }
  }
}