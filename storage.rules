rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {

    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(uid) {
      return isAuthenticated() && request.auth.uid == uid;
    }

    // Conservative allowlist for common student resource uploads
    function isAllowedContentType() {
      return request.resource.contentType.matches('application/pdf')
        || request.resource.contentType.matches('image/.*')
        || request.resource.contentType.matches('application/vnd.ms-powerpoint')
        || request.resource.contentType.matches('application/vnd.openxmlformats-officedocument.presentationml.presentation')
        || request.resource.contentType.matches('application/msword')
        || request.resource.contentType.matches('application/vnd.openxmlformats-officedocument.wordprocessingml.document');
    }

    // 25MB max per file (tune as needed)
    function isWithinSizeLimit() {
      return request.resource.size < 25 * 1024 * 1024;
    }

    // User avatars / profile assets
    match /users/{uid}/{allPaths=**} {
      allow read: if isOwner(uid);
      allow write: if isOwner(uid)
        && isWithinSizeLimit()
        && request.resource.contentType.matches('image/.*');
    }

    // Resource uploads (legacy/optional; current file uploads use an external provider)
    match /resources/{uid}/{resourceId}/{filename} {
      allow read: if isAuthenticated();
      allow write: if isOwner(uid)
        && isWithinSizeLimit()
        && isAllowedContentType();
    }

    // Deny everything else
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
